/*===================================================================================
 Copyright (c) 2020 Qualcomm Technologies, Inc.
 All Rights Reserved.
 Confidential and Proprietary - Qualcomm Technologies, Inc.
 ===================================================================================*/

/*-----------------------------------------------------------------------------------
 INCLUDE FILES FOR MODULE
 ------------------------------------------------------------------------------------*/
#include <Uefi.h>
#include <Library/UefiBootServicesTableLib.h>
#include <Library/TestInterface.h>
#include <Library/QcomBaseLib.h>
#include <Protocol/EFIScm.h>
#include <Protocol/EFIShmBridge.h>
#include <Library/QcomLib.h>

#include <object.h>
#include "IClientEnv.h"
#include "IPFM.h"
#include "CPFM.h"
#include "UsefulBuf.h"

/*-----------------------------------------------------------------------------------
 CONSTANT DEFINITIONS
 -------------------------------------------------------------------------------------*/
#define Pass                        0
#define Fail                        1
#define EndOfList                   2

#define MAX_SERIAL_NUM              24
#define MAX_FIDs_CBOR               1024
#define MAX_RESPONSE_CBOR           2048

#define HEX_COLUMNS 16
#define MAX_HEX_LEN (3 * HEX_COLUMNS + 1)

/*-----------------------------------------------------------------------------------
 TYPEDEF DEFINITIONS
 -------------------------------------------------------------------------------------*/
typedef int (*APITestsCallBack)(int nTestNumber, const char **pszTestName);

/*-----------------------------------------------------------------------------------
 GLOBAL DECLARATIONS
 -------------------------------------------------------------------------------------*/
QCOM_SCM_PROTOCOL *ScmProtocol = NULL;
EFI_SHMBRIDGE_PROTOCOL *ShmBridgeProtocol = NULL;

static Object appObj = Object_NULL;
static Object clientEnv = Object_NULL;

// CheckInstalledLicense ***********************************************************
static const UsefulBufC EmptyCert = NULLUsefulBufC;
static const UsefulBufC EmptyLicenseeHash = NULLUsefulBufC;

static const UsefulBufC ALLEXTENSIONSCERT_SerialNum = {
    (uint8_t[]) {
    0x6a,0xed,0x5d,0xd3,0x09,0xe6,0xf6,0x7b,0x55,0xaf,0xf4,0xcc,0x00,0x00,0x01,0x79,
    0x48,0xdf,0xc4,0xcc
    },
    20
};

static const UsefulBufC NOEXPIRATIONCERT_SerialNum = {
    (uint8_t[]) {
    0x58,0x4a,0xe7,0xbd,0xc2,0x97,0xb9,0xe1,0xd8,0x85,0x79,0x4c,0x00,0x00,0x01,0x79,
    0x49,0x1b,0x48,0x5b
    },
    20
};

static const UsefulBufC EXPIREDGPCERT_SerialNum = {
    (uint8_t[]) {
    0x44,0x57,0x8c,0x40,0xc6,0x90,0x8f,0x3a,0xd4,0xdd,0xd5,0xd1,0x00,0x00,0x01,0x79,
    0x49,0x16,0x75,0x0c
    },
    20
};

static const UsefulBufC DEVICEIDCERT_SerialNum = {
    (uint8_t[]) {
    0x68,0x56,0x0c,0xb7,0xd5,0x2a,0x1d,0x30,0xf3,0xe4,0xb1,0xfb,0x00,0x00,0x01,0x7a,
    0x1b,0x81,0x55,0xc1
    },
    20
};

static const UsefulBufC OEM1_QWESPKHASHCERT_SerialNum = {
    (uint8_t[]) {
    0x05,0x20,0xdf,0xd5,0x75,0x26,0x7e,0x44,0x46,0xa9,0x66,0xee,0x00,0x00,0x01,0x79,
    0x49,0x1e,0x17,0x3b
    },
    20
};

static struct CheckInstalledLicenseTestParams {
   const char *szTestName;
   const uint64_t uOpts;
   const uint32_t uFeatureID;
   const UsefulBufC *Cert;
   const UsefulBufC *LicenseeHash;
   const UsefulBufC *ExpSerialNum;
   int ExpReturn;
   BOOLEAN ValidateResponse;
}  CILTests[] = {

   {
      "AllExtns_Match_Test",
      0,
      69,
      &EmptyCert,
      &EmptyLicenseeHash,
      &ALLEXTENSIONSCERT_SerialNum,
      Object_OK,
      TRUE
   },
   {
      "NoExpiration_Test",
      0,
      69,
      &EmptyCert,
      &EmptyLicenseeHash,
      &NOEXPIRATIONCERT_SerialNum,
      Object_OK,
      TRUE
   },
   {
      "ExpiredGP_Test",
      0,
      69,
      &EmptyCert,
      &EmptyLicenseeHash,
      &EXPIREDGPCERT_SerialNum,
      Object_OK,
      FALSE
   },
   {
      "DeviceID_Match_Test",
      0,
      96,
      &EmptyCert,
      &EmptyLicenseeHash,
      &DEVICEIDCERT_SerialNum,
      Object_OK,
      FALSE
   },
   {
      "OEM1_QWESPKHash_Test",
      0,
      69,
      &EmptyCert,
      &EmptyLicenseeHash,
      &OEM1_QWESPKHASHCERT_SerialNum,
      Object_OK,
      TRUE
   },
};

//GetInstalledLicenseInfo ***********************************************************
static const UsefulBufC GILI_ExpResponseCBOR_1 = {
    (uint8_t[]) {
    0xAC,0x68,0x46,0x69,0x6C,0x65,0x4E,0x61,0x6D,0x65,0x60,0x6C,0x53,0x65,0x72,0x69,
    0x61,0x6C,0x4E,0x75,0x6D,0x62,0x65,0x72,0x54,0x6A,0xED,0x5D,0xD3,0x09,0xE6,0xF6,
    0x7B,0x55,0xAF,0xF4,0xCC,0x00,0x00,0x01,0x79,0x48,0xDF,0xC4,0xCC,0x66,0x49,0x73,
    0x73,0x75,0x65,0x72,0xA3,0x61,0x4F,0x78,0x1B,0x51,0x75,0x61,0x6C,0x63,0x6F,0x6D,
    0x6D,0x20,0x54,0x65,0x63,0x68,0x6E,0x6F,0x6C,0x6F,0x67,0x69,0x65,0x73,0x2C,0x20,
    0x49,0x6E,0x63,0x2E,0x62,0x4F,0x55,0x78,0x21,0x51,0x75,0x61,0x6C,0x63,0x6F,0x6D,
    0x6D,0x20,0x43,0x72,0x79,0x70,0x74,0x6F,0x67,0x72,0x61,0x70,0x68,0x69,0x63,0x20,
    0x4F,0x70,0x65,0x72,0x61,0x74,0x69,0x6F,0x6E,0x73,0x62,0x43,0x4E,0x72,0x43,0x48,
    0x4C,0x53,0x45,0x20,0x53,0x69,0x67,0x6E,0x69,0x6E,0x67,0x20,0x43,0x65,0x72,0x74,
    0x6C,0x53,0x75,0x62,0x6A,0x65,0x63,0x74,0x4B,0x65,0x79,0x49,0x44,0x40,0x69,0x53,
    0x75,0x62,0x6A,0x65,0x63,0x74,0x44,0x4E,0xA3,0x62,0x43,0x4E,0x78,0x1B,0x6F,0x65,
    0x6D,0x5F,0x30,0x5F,0x70,0x72,0x6A,0x5F,0x41,0x4C,0x4C,0x45,0x58,0x54,0x45,0x4E,
    0x53,0x49,0x4F,0x4E,0x53,0x43,0x45,0x52,0x54,0x61,0x4F,0x78,0x1B,0x51,0x75,0x61,
    0x6C,0x63,0x6F,0x6D,0x6D,0x20,0x54,0x65,0x63,0x68,0x6E,0x6F,0x6C,0x6F,0x67,0x69,
    0x65,0x73,0x2C,0x20,0x49,0x6E,0x63,0x2E,0x62,0x4F,0x55,0x78,0x21,0x51,0x75,0x61,
    0x6C,0x63,0x6F,0x6D,0x6D,0x20,0x43,0x72,0x79,0x70,0x74,0x6F,0x67,0x72,0x61,0x70,
    0x68,0x69,0x63,0x20,0x4f,0x70,0x65,0x72,0x61,0x74,0x69,0x6f,0x6e,0x73,0x78,0x19,
    0x45,0x78,0x70,0x69,0x72,0x61,0x74,0x69,0x6f,0x6e,0x57,0x69,0x74,0x68,0x47,0x72,
    0x61,0x63,0x65,0x50,0x65,0x72,0x69,0x6f,0x64,0x58,0x24,0x00,0x00,0x00,0x01,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x67,0x74,0x85,0x7f,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x6e,
    0x4c,0x69,0x63,0x65,0x6e,0x73,0x65,0x65,0x48,0x61,0x73,0x68,0x65,0x73,0x40,0x64,
    0x46,0x49,0x44,0x73,0x81,0x18,0x45,0x69,0x46,0x49,0x44,0x52,0x61,0x6e,0x67,0x65,
    0x73,0x80,0x73,0x4c,0x69,0x63,0x65,0x6e,0x73,0x65,0x52,0x65,0x73,0x74,0x72,0x69,
    0x63,0x74,0x69,0x6f,0x6e,0x73,0x18,0xab,0x69,0x45,0x78,0x74,0x72,0x61,0x44,0x61,
    0x74,0x61,0x48,0x50,0x46,0x4d,0x52,0x6f,0x63,0x6b,0x73,0x64,0x46,0x6c,0x61,0x67,
    0x00,
    },
    417
};

static const UsefulBufC GILI_ExpResponseCBOR_2 = {
    (uint8_t[]) {
    0xAC,0x68,0x46,0x69,0x6C,0x65,0x4E,0x61,0x6D,0x65,0x60,0x6C,0x53,0x65,0x72,0x69,
    0x61,0x6C,0x4E,0x75,0x6D,0x62,0x65,0x72,0x54,0x58,0x4A,0xE7,0xBD,0xC2,0x97,0xB9,
    0xE1,0xD8,0x85,0x79,0x4C,0x00,0x00,0x01,0x79,0x49,0x1B,0x48,0x5B,0x66,0x49,0x73,
    0x73,0x75,0x65,0x72,0xA3,0x61,0x4F,0x78,0x1B,0x51,0x75,0x61,0x6C,0x63,0x6F,0x6D,
    0x6D,0x20,0x54,0x65,0x63,0x68,0x6E,0x6F,0x6C,0x6F,0x67,0x69,0x65,0x73,0x2C,0x20,
    0x49,0x6E,0x63,0x2E,0x62,0x4F,0x55,0x78,0x21,0x51,0x75,0x61,0x6C,0x63,0x6F,0x6D,
    0x6D,0x20,0x43,0x72,0x79,0x70,0x74,0x6F,0x67,0x72,0x61,0x70,0x68,0x69,0x63,0x20,
    0x4F,0x70,0x65,0x72,0x61,0x74,0x69,0x6F,0x6E,0x73,0x62,0x43,0x4E,0x72,0x43,0x48,
    0x4C,0x53,0x45,0x20,0x53,0x69,0x67,0x6E,0x69,0x6E,0x67,0x20,0x43,0x65,0x72,0x74,
    0x6C,0x53,0x75,0x62,0x6A,0x65,0x63,0x74,0x4B,0x65,0x79,0x49,0x44,0x40,0x69,0x53,
    0x75,0x62,0x6A,0x65,0x63,0x74,0x44,0x4E,0xA3,0x62,0x43,0x4E,0x78,0x1A,0x6F,0x65,
    0x6D,0x5F,0x30,0x5F,0x70,0x72,0x6A,0x5F,0x4E,0x4F,0x45,0x58,0x50,0x49,0x52,0x41,
    0x54,0x49,0x4F,0x4E,0x43,0x45,0x52,0x54,0x61,0x4F,0x78,0x1B,0x51,0x75,0x61,0x6C,
    0x63,0x6F,0x6D,0x6D,0x20,0x54,0x65,0x63,0x68,0x6E,0x6F,0x6C,0x6F,0x67,0x69,0x65,
    0x73,0x2C,0x20,0x49,0x6E,0x63,0x2E,0x62,0x4F,0x55,0x78,0x21,0x51,0x75,0x61,0x6C,
    0x63,0x6F,0x6D,0x6D,0x20,0x43,0x72,0x79,0x70,0x74,0x6F,0x67,0x72,0x61,0x70,0x68,
    0x69,0x63,0x20,0x4F,0x70,0x65,0x72,0x61,0x74,0x69,0x6F,0x6E,0x73,0x6A,0x45,0x78,
    0x70,0x69,0x72,0x61,0x74,0x69,0x6F,0x6E,0x40,0x6E,0x4C,0x69,0x63,0x65,0x6E,0x73,
    0x65,0x65,0x48,0x61,0x73,0x68,0x65,0x73,0x40,0x64,0x46,0x49,0x44,0x73,0x81,0x18,
    0x45,0x69,0x46,0x49,0x44,0x52,0x61,0x6E,0x67,0x65,0x73,0x80,0x73,0x4C,0x69,0x63,
    0x65,0x6E,0x73,0x65,0x52,0x65,0x73,0x74,0x72,0x69,0x63,0x74,0x69,0x6F,0x6E,0x73,
    0x03,0x69,0x45,0x78,0x74,0x72,0x61,0x44,0x61,0x74,0x61,0x40,0x64,0x46,0x6C,0x61,
    0x67,0x00,
    },
    354
};

static const UsefulBufC GILI_ExpResponseCBOR_3 = {
    (uint8_t[]) {
    0xAC,0x68,0x46,0x69,0x6C,0x65,0x4E,0x61,0x6D,0x65,0x60,0x6C,0x53,0x65,0x72,0x69,
    0x61,0x6C,0x4E,0x75,0x6D,0x62,0x65,0x72,0x54,0x44,0x57,0x8C,0x40,0xC6,0x90,0x8F,
    0x3A,0xD4,0xDD,0xD5,0xD1,0x00,0x00,0x01,0x79,0x49,0x16,0x75,0x0C,0x66,0x49,0x73,
    0x73,0x75,0x65,0x72,0xA3,0x61,0x4F,0x78,0x1B,0x51,0x75,0x61,0x6C,0x63,0x6F,0x6D,
    0x6D,0x20,0x54,0x65,0x63,0x68,0x6E,0x6F,0x6C,0x6F,0x67,0x69,0x65,0x73,0x2C,0x20,
    0x49,0x6E,0x63,0x2E,0x62,0x4F,0x55,0x78,0x21,0x51,0x75,0x61,0x6C,0x63,0x6F,0x6D,
    0x6D,0x20,0x43,0x72,0x79,0x70,0x74,0x6F,0x67,0x72,0x61,0x70,0x68,0x69,0x63,0x20,
    0x4F,0x70,0x65,0x72,0x61,0x74,0x69,0x6F,0x6E,0x73,0x62,0x43,0x4E,0x72,0x43,0x48,
    0x4C,0x53,0x45,0x20,0x53,0x69,0x67,0x6E,0x69,0x6E,0x67,0x20,0x43,0x65,0x72,0x74,
    0x6C,0x53,0x75,0x62,0x6A,0x65,0x63,0x74,0x4B,0x65,0x79,0x49,0x44,0x40,0x69,0x53,
    0x75,0x62,0x6A,0x65,0x63,0x74,0x44,0x4E,0xA3,0x62,0x43,0x4E,0x77,0x6F,0x65,0x6D,
    0x5F,0x30,0x5F,0x70,0x72,0x6A,0x5F,0x45,0x58,0x50,0x49,0x52,0x45,0x44,0x47,0x50,
    0x43,0x45,0x52,0x54,0x61,0x4F,0x78,0x1B,0x51,0x75,0x61,0x6C,0x63,0x6F,0x6D,0x6D,
    0x20,0x54,0x65,0x63,0x68,0x6E,0x6F,0x6C,0x6F,0x67,0x69,0x65,0x73,0x2C,0x20,0x49,
    0x6E,0x63,0x2E,0x62,0x4F,0x55,0x78,0x21,0x51,0x75,0x61,0x6C,0x63,0x6F,0x6D,0x6D,
    0x20,0x43,0x72,0x79,0x70,0x74,0x6F,0x67,0x72,0x61,0x70,0x68,0x69,0x63,0x20,0x4F,
    0x70,0x65,0x72,0x61,0x74,0x69,0x6F,0x6E,0x73,0x6A,0x45,0x78,0x70,0x69,0x72,0x61,
    0x74,0x69,0x6F,0x6E,0x40,0x6E,0x4C,0x69,0x63,0x65,0x6E,0x73,0x65,0x65,0x48,0x61,
    0x73,0x68,0x65,0x73,0x40,0x64,0x46,0x49,0x44,0x73,0x81,0x18,0x45,0x69,0x46,0x49,
    0x44,0x52,0x61,0x6E,0x67,0x65,0x73,0x80,0x73,0x4C,0x69,0x63,0x65,0x6E,0x73,0x65,
    0x52,0x65,0x73,0x74,0x72,0x69,0x63,0x74,0x69,0x6F,0x6E,0x73,0x18,0xA3,0x69,0x45,
    0x78,0x74,0x72,0x61,0x44,0x61,0x74,0x61,0x40,0x64,0x46,0x6C,0x61,0x67,0x00,
    },
    351
};

static const UsefulBufC GILI_ExpResponseCBOR_4 = {
    (uint8_t[]) {
    0xAC,0x68,0x46,0x69,0x6C,0x65,0x4E,0x61,0x6D,0x65,0x60,0x6C,0x53,0x65,0x72,0x69,
    0x61,0x6C,0x4E,0x75,0x6D,0x62,0x65,0x72,0x54,0x79,0xB5,0x38,0x40,0xED,0x7D,0x51,
    0x39,0x22,0xFA,0x32,0x5B,0x00,0x00,0x01,0x79,0x49,0x21,0x51,0xB8,0x66,0x49,0x73,
    0x73,0x75,0x65,0x72,0xA3,0x61,0x4F,0x78,0x1B,0x51,0x75,0x61,0x6C,0x63,0x6F,0x6D,
    0x6D,0x20,0x54,0x65,0x63,0x68,0x6E,0x6F,0x6C,0x6F,0x67,0x69,0x65,0x73,0x2C,0x20,
    0x49,0x6E,0x63,0x2E,0x62,0x4F,0x55,0x78,0x21,0x51,0x75,0x61,0x6C,0x63,0x6F,0x6D,
    0x6D,0x20,0x43,0x72,0x79,0x70,0x74,0x6F,0x67,0x72,0x61,0x70,0x68,0x69,0x63,0x20,
    0x4F,0x70,0x65,0x72,0x61,0x74,0x69,0x6F,0x6E,0x73,0x62,0x43,0x4E,0x72,0x43,0x48,
    0x4C,0x53,0x45,0x20,0x53,0x69,0x67,0x6E,0x69,0x6E,0x67,0x20,0x43,0x65,0x72,0x74,
    0x6C,0x53,0x75,0x62,0x6A,0x65,0x63,0x74,0x4B,0x65,0x79,0x49,0x44,0x40,0x69,0x53,
    0x75,0x62,0x6A,0x65,0x63,0x74,0x44,0x4E,0xA3,0x62,0x43,0x4E,0x76,0x6F,0x65,0x6D,
    0x5F,0x30,0x5F,0x70,0x72,0x6A,0x5F,0x44,0x45,0x56,0x49,0x43,0x45,0x49,0x44,0x43,
    0x45,0x52,0x54,0x61,0x4F,0x78,0x1B,0x51,0x75,0x61,0x6C,0x63,0x6F,0x6D,0x6D,0x20,
    0x54,0x65,0x63,0x68,0x6E,0x6F,0x6C,0x6F,0x67,0x69,0x65,0x73,0x2C,0x20,0x49,0x6E,
    0x63,0x2E,0x62,0x4F,0x55,0x78,0x21,0x51,0x75,0x61,0x6C,0x63,0x6F,0x6D,0x6D,0x20,
    0x43,0x72,0x79,0x70,0x74,0x6F,0x67,0x72,0x61,0x70,0x68,0x69,0x63,0x20,0x4F,0x70,
    0x65,0x72,0x61,0x74,0x69,0x6F,0x6E,0x73,0x6A,0x45,0x78,0x70,0x69,0x72,0x61,0x74,
    0x69,0x6F,0x6E,0x40,0x6E,0x4C,0x69,0x63,0x65,0x6E,0x73,0x65,0x65,0x48,0x61,0x73,
    0x68,0x65,0x73,0x40,0x64,0x46,0x49,0x44,0x73,0x80,0x69,0x46,0x49,0x44,0x52,0x61,
    0x6E,0x67,0x65,0x73,0x81,0x82,0x00,0x18,0x63,0x73,0x4C,0x69,0x63,0x65,0x6E,0x73,
    0x65,0x52,0x65,0x73,0x74,0x72,0x69,0x63,0x74,0x69,0x6F,0x6E,0x73,0x18,0xA7,0x69,
    0x45,0x78,0x74,0x72,0x61,0x44,0x61,0x74,0x61,0x40,0x64,0x46,0x6C,0x61,0x67,0x00,
    },
    352
};

static const UsefulBufC GILI_ExpResponseCBOR_5 = {
    (uint8_t[]) {
    0xAC,0x68,0x46,0x69,0x6C,0x65,0x4E,0x61,0x6D,0x65,0x60,0x6C,0x53,0x65,0x72,0x69,
    0x61,0x6C,0x4E,0x75,0x6D,0x62,0x65,0x72,0x54,0x05,0x20,0xDF,0xD5,0x75,0x26,0x7E,
    0x44,0x46,0xA9,0x66,0xEE,0x00,0x00,0x01,0x79,0x49,0x1E,0x17,0x3B,0x66,0x49,0x73,
    0x73,0x75,0x65,0x72,0xA3,0x61,0x4F,0x78,0x1B,0x51,0x75,0x61,0x6C,0x63,0x6F,0x6D,
    0x6D,0x20,0x54,0x65,0x63,0x68,0x6E,0x6F,0x6C,0x6F,0x67,0x69,0x65,0x73,0x2C,0x20,
    0x49,0x6E,0x63,0x2E,0x62,0x4F,0x55,0x78,0x21,0x51,0x75,0x61,0x6C,0x63,0x6F,0x6D,
    0x6D,0x20,0x43,0x72,0x79,0x70,0x74,0x6F,0x67,0x72,0x61,0x70,0x68,0x69,0x63,0x20,
    0x4F,0x70,0x65,0x72,0x61,0x74,0x69,0x6F,0x6E,0x73,0x62,0x43,0x4E,0x72,0x43,0x48,
    0x4C,0x53,0x45,0x20,0x53,0x69,0x67,0x6E,0x69,0x6E,0x67,0x20,0x43,0x65,0x72,0x74,
    0x6C,0x53,0x75,0x62,0x6A,0x65,0x63,0x74,0x4B,0x65,0x79,0x49,0x44,0x40,0x69,0x53,
    0x75,0x62,0x6A,0x65,0x63,0x74,0x44,0x4E,0xA3,0x62,0x43,0x4E,0x78,0x18,0x6F,0x65,
    0x6D,0x5F,0x31,0x5F,0x70,0x72,0x6A,0x5F,0x51,0x57,0x45,0x53,0x50,0x4B,0x48,0x41,
    0x53,0x48,0x43,0x45,0x52,0x54,0x61,0x4F,0x78,0x1B,0x51,0x75,0x61,0x6C,0x63,0x6F,
    0x6D,0x6D,0x20,0x54,0x65,0x63,0x68,0x6E,0x6F,0x6C,0x6F,0x67,0x69,0x65,0x73,0x2C,
    0x20,0x49,0x6E,0x63,0x2E,0x62,0x4F,0x55,0x78,0x21,0x51,0x75,0x61,0x6C,0x63,0x6F,
    0x6D,0x6D,0x20,0x43,0x72,0x79,0x70,0x74,0x6F,0x67,0x72,0x61,0x70,0x68,0x69,0x63,    
    0x20,0x4f,0x70,0x65,0x72,0x61,0x74,0x69,0x6f,0x6e,0x73,0x78,0x19,0x45,0x78,0x70,
    0x69,0x72,0x61,0x74,0x69,0x6f,0x6e,0x57,0x69,0x74,0x68,0x47,0x72,0x61,0x63,0x65,
    0x50,0x65,0x72,0x69,0x6f,0x64,0x58,0x24,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x67,0x74,0x85,0x7f,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x6e,0x4c,0x69,0x63, 
    0x65,0x6e,0x73,0x65,0x65,0x48,0x61,0x73,0x68,0x65,0x73,0x40,0x64,0x46,0x49,0x44,
    0x73,0x81,0x18,0x45,0x69,0x46,0x49,0x44,0x52,0x61,0x6e,0x67,0x65,0x73,0x80,0x73,
    0x4c,0x69,0x63,0x65,0x6e,0x73,0x65,0x52,0x65,0x73,0x74,0x72,0x69,0x63,0x74,0x69,
    0x6f,0x6e,0x73,0x18,0xab,0x69,0x45,0x78,0x74,0x72,0x61,0x44,0x61,0x74,0x61,0x40,
    0x64,0x46,0x6c,0x61,0x67,0x00,
    },
    406
};

static struct GetInstalledLicenseInfoTestParams {
   const char *szTestName;
   const uint64_t uOpts;
   const UsefulBufC *Cert;
   const UsefulBufC *SerialNum;
   const UsefulBufC *ExpResponseCBOR;
   int ExpReturn;
   BOOLEAN ValidateResponse;
}  GILITests[] = {

   {
      "AllExtns_Match_Test",
      0,
      &EmptyCert,
      &ALLEXTENSIONSCERT_SerialNum,
      &GILI_ExpResponseCBOR_1,
      Object_OK,
      TRUE
   },
   {
      "NoExpiration_Test",
      0,
      &EmptyCert,
      &NOEXPIRATIONCERT_SerialNum,
      &GILI_ExpResponseCBOR_2,
      Object_OK,
      TRUE
   },
   {
      "ExpiredGP_Test",
      0,
      &EmptyCert,
      &EXPIREDGPCERT_SerialNum,
      &GILI_ExpResponseCBOR_3,
      Object_OK,
      FALSE
   },
   {
      "DeviceID_Match_Test",
      0,
      &EmptyCert,
      &DEVICEIDCERT_SerialNum,
      &GILI_ExpResponseCBOR_4,
      Object_OK,
      FALSE
   },
   {
      "OEM1_QWESPKHash_Test",
      0,
      &EmptyCert,
      &OEM1_QWESPKHASHCERT_SerialNum,
      &GILI_ExpResponseCBOR_5,
      Object_OK,
      TRUE
   },
};

//GetAllInstalledSerialNumbers ******************************************************
static const UsefulBufC ALLEXTENSIONSCERT_SerialNum_CBOR = {
    (uint8_t[]) {
    0x81,0x54,0x6a,0xed,0x5d,0xd3,0x09,0xe6,0xf6,0x7b,0x55,0xaf,0xf4,0xcc,0x00,0x00,
    0x01,0x79,0x48,0xdf,0xc4,0xcc
    },
    22
};

static const UsefulBufC NOEXPIRATIONCERT_SerialNum_CBOR = {
    (uint8_t[]) {
    0x81,0x54,0x58,0x4a,0xe7,0xbd,0xc2,0x97,0xb9,0xe1,0xd8,0x85,0x79,0x4c,0x00,0x00,
    0x01,0x79,0x49,0x1b,0x48,0x5b
    },
    22
};

static const UsefulBufC EXPIREDGPCERT_SerialNum_CBOR = {
    (uint8_t[]) {
    0x81,0x54,0x44,0x57,0x8c,0x40,0xc6,0x90,0x8f,0x3a,0xd4,0xdd,0xd5,0xd1,0x00,0x00,
    0x01,0x79,0x49,0x16,0x75,0x0c
    },
    22
};

static const UsefulBufC DEVICEIDCERT_SerialNum_CBOR = {
    (uint8_t[]) {
    0x81,0x54,0x68,0x56,0x0c,0xb7,0xd5,0x2a,0x1d,0x30,0xf3,0xe4,0xb1,0xfb,0x00,0x00,
    0x01,0x7a,0x1b,0x81,0x55,0xc1
    },
    22
};

static const UsefulBufC OEM1_QWESPKHASHCERT_SerialNum_CBOR = {
    (uint8_t[]) {
    0x81,0x54,0x05,0x20,0xdf,0xd5,0x75,0x26,0x7e,0x44,0x46,0xa9,0x66,0xee,0x00,0x00,
    0x01,0x79,0x49,0x1e,0x17,0x3b
    },
    22
};

static struct GetAllInstalledSerialNumbersTestParams {
   const char *szTestName;
   const uint64_t uOpts;
   const UsefulBufC *ExpSerialNumCBOR;
   int ExpReturn;
   BOOLEAN ValidateResponse;
}  GAISNTests[] = {

   {
      "AllExtns_Match_Test",
      0,
      &ALLEXTENSIONSCERT_SerialNum_CBOR,
      Object_OK,
      TRUE
   },
   {
      "NoExpiration_Test",
      0,
      &NOEXPIRATIONCERT_SerialNum_CBOR,
      Object_OK,
      TRUE
   },
   {
      "ExpiredGP_Test",
      0,
      &EXPIREDGPCERT_SerialNum_CBOR,
      Object_OK,
      FALSE
   },
   {
      "DeviceID_Match_Test",
      0,
      &DEVICEIDCERT_SerialNum_CBOR,
      Object_OK,
      FALSE
   },
   {
      "OEM1_QWESPKHash_Test",
      0,
      &OEM1_QWESPKHASHCERT_SerialNum_CBOR,
      Object_OK,
      TRUE
   },
};

//CheckLicenseBuffer *****************************************************************
static const char szCLB_allExtns_Cert[] =
    "-----BEGIN CERTIFICATE-----"
    "MIIFBzCCA7ugAwIBAgIUau1d0wnm9ntVr/TMAAABeUjfxMwwQQYJKoZIhvcNAQEK"
    "MDSgDzANBglghkgBZQMEAgEFAKEcMBoGCSqGSIb3DQEBCDANBglghkgBZQMEAgEF"
    "AKIDAgEgMG8xJDAiBgNVBAoMG1F1YWxjb21tIFRlY2hub2xvZ2llcywgSW5jLjEq"
    "MCgGA1UECwwhUXVhbGNvbW0gQ3J5cHRvZ3JhcGhpYyBPcGVyYXRpb25zMRswGQYD"
    "VQQDDBJDSExTRSBTaWduaW5nIENlcnQwHhcNNzAwMTAxMDAwMDAxWhcNMjQxMjMx"
    "MjM1OTU5WjB4MSQwIgYDVQQDDBtvZW1fMF9wcmpfQUxMRVhURU5TSU9OU0NFUlQx"
    "JDAiBgNVBAoMG1F1YWxjb21tIFRlY2hub2xvZ2llcywgSW5jLjEqMCgGA1UECwwh"
    "UXVhbGNvbW0gQ3J5cHRvZ3JhcGhpYyBPcGVyYXRpb25zMIIBIDALBgkqhkiG9w0B"
    "AQEDggEPADCCAQoCggEBAP//////////////////////////////////////////"
    "////////////////////////////////////////////////////////////////"
    "////////////////////////////////////////////////////////////////"
    "////////////////////////////////////////////////////////////////"
    "////////////////////////////////////////////////////////////////"
    "//////////////////////////////////////////8CAwEAAaOCASowggEmMB8G"
    "A1UdIwQYMBaAFIcU6Tcyfr22KPwwamAkEDDYveduMAwGA1UdEwEB/wQCMAAwDgYD"
    "VR0PAQH/BAQDAgWgMBUGCSsGAQQBiykMAQQIAAAAAAAAAEUwFgYKKwYBBAGLKQsB"
    "AQQIAAAAAAAAAAAwFQYJKwYBBAGLKQwGBAhQRk1Sb2NrczAiBgorBgEEAYspCwEC"
    "BBQAAAAAAABgDwAAoAEAAGAYAACgAzAZBgkrBgEEAYspDAIEDAAAAAEAAAABZ3SF"
    "fzAxBgkrBgEEAYspDAgEJAAAAAEAAAAAAAAAAQAAAABndIV/AAAAAAAAAAAAAAAA"
    "AAAAADAtBgkrBgEEAYspDAUEICCtK0DTfO9auYe0k+Fjmc3AQvOHWqfU2Vtwjk9G"
    "91v6MEEGCSqGSIb3DQEBCjA0oA8wDQYJYIZIAWUDBAIBBQChHDAaBgkqhkiG9w0B"
    "AQgwDQYJYIZIAWUDBAIBBQCiAwIBIAOCAQEA3qgpPIAqe0+YrA24GlinDkGDuwb5"
    "0VUYOB42Lu6jT3A9yPy4JWwkWqpq0A2oYzHqvJpWBV6CJjy379mT9+tlU8M7TYGF"
    "k8WXTRICfqspD1V2ga0Wd3ZdhcLzilMqV3BUB1sSX0vR5UMAkKJQeMVvUom6tL+P"
    "fkiXrPqov/+OmbC0hkJLdWQgWSHfkIJ0BJXqI63muM1QsLxtDMSh1F/cwNP6fk38"
    "XHOJwbNtSciBPtMkMuVVAFscIP+fyd5QNjjqFGWyN2mCNedekwu9el5IFyTlimgo"
    "uTTF8mXXtbZJQ8Fe4N8D6/aI98OEItxWGIqMaPUTiTRcbOhDV888MuvlHw=="
    "-----END CERTIFICATE-----"
    "-----BEGIN CERTIFICATE-----"
    "MIIERTCCAv2gAwIBAgIVdqMEQ1j41p18D3AfzC1TDxRDgyKzMD0GCSqGSIb3DQEB"
    "CjAwoA0wCwYJYIZIAWUDBAIBoRowGAYJKoZIhvcNAQEIMAsGCWCGSAFlAwQCAaID"
    "AgEgMIGAMSQwIgYDVQQKDBtRdWFsY29tbSBUZWNobm9sb2dpZXMsIEluYy4xKjAo"
    "BgNVBAsMIVF1YWxjb21tIENyeXB0b2dyYXBoaWMgT3BlcmF0aW9uczEsMCoGA1UE"
    "AwwjRmVhdHVyZSBMaWNlbnNlIEF0dGVzdGF0aW9uIFJvb3QgQ0EwHhcNMTgxMjE0"
    "MDAwMDAxWhcNMjgxMjEzMjM1OTU5WjBvMSQwIgYDVQQKDBtRdWFsY29tbSBUZWNo"
    "bm9sb2dpZXMsIEluYy4xKjAoBgNVBAsMIVF1YWxjb21tIENyeXB0b2dyYXBoaWMg"
    "T3BlcmF0aW9uczEbMBkGA1UEAwwSQ0hMU0UgU2lnbmluZyBDZXJ0MIIBIjANBgkq"
    "hkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA7TyI/YJ2Mfipye29tcEW/jtWS/6sCgKK"
    "ogvkmeHBM07h3CwYDFBOBg+MqgqzNUpygj3wJ5ahLkG/HmxNg3CSXeIVlTt+cEZh"
    "ie0TW+s/rxi4ODLQ9v+UAoDszB0bk8gOd8HGs6CtKXCONDx/W3PSGn/+hTWpqE2G"
    "PsH4EqjI2uegyw4xMxO78iC9adn7fOGZFec1HaL4KmrWe+Vqg1KLIYx55ZrQFq5h"
    "/vP+hKlWSZP/HtY3knlQ2DcqickRAhz//C8wsxso+pjKdHHfDers0W02kzL0Cljk"
    "OpJedpnjd+JHLprysuEShJQ5vDIC48fsj5qwy315uyfpXOYcII2qOQIDAQABo2Yw"
    "ZDASBgNVHRMBAf8ECDAGAQH/AgEAMA4GA1UdDwEB/wQEAwIChDAdBgNVHQ4EFgQU"
    "hxTpNzJ+vbYo/DBqYCQQMNi9524wHwYDVR0jBBgwFoAU8kGYj4IIg0uJcAYVO7al"
    "Tpt5aAgwPQYJKoZIhvcNAQEKMDCgDTALBglghkgBZQMEAgGhGjAYBgkqhkiG9w0B"
    "AQgwCwYJYIZIAWUDBAIBogMCASADggEBAIlYDO7RnIdPDozvWshfuvQ3VawcjGSm"
    "KLJGp11MxM2Kd5SPTVT+uisLntJ6CY+FNdCc7zF2F9Va36rlIKYzqNBsmtOHF6Nf"
    "RBEssoJb5Tq81ZYDM5wsG+CMtS8wZ09M0ObkixzZFePidF/NIfPx1cj/FXEyosZ8"
    "lC0VXF8DG90waxrhY5W/ziBJTy7BTFNlgdMFw/wP+Wm+1PzqPESnDcgKr2D8lYGY"
    "kyP2AUNEmQkr/P2wqjYmFwUl8Fu6vyfXXLrBD3DN+MprdUP2d+fxr6kcVfjikzfU"
    "ZkHrvWqUb3z63I2NMPXnoDq3ZcN+1eE15JqfFk68Z6gNh3qjcFyaI0g="
    "-----END CERTIFICATE-----";
static const UsefulBufC CLB_allExtns_Cert = { szCLB_allExtns_Cert, sizeof(szCLB_allExtns_Cert) };

static const UsefulBufC ExpLicenseInfoCBOR = {
    (uint8_t[]) {
    0xAB,0x6C,0x53,0x65,0x72,0x69,0x61,0x6C,0x4E,0x75,0x6D,0x62,0x65,0x72,0x54,0x6A,
    0xED,0x5D,0xD3,0x09,0xE6,0xF6,0x7B,0x55,0xAF,0xF4,0xCC,0x00,0x00,0x01,0x79,0x48,
    0xDF,0xC4,0xCC,0x66,0x49,0x73,0x73,0x75,0x65,0x72,0xA3,0x61,0x4F,0x78,0x1B,0x51,
    0x75,0x61,0x6C,0x63,0x6F,0x6D,0x6D,0x20,0x54,0x65,0x63,0x68,0x6E,0x6F,0x6C,0x6F,
    0x67,0x69,0x65,0x73,0x2C,0x20,0x49,0x6E,0x63,0x2E,0x62,0x4F,0x55,0x78,0x21,0x51,
    0x75,0x61,0x6C,0x63,0x6F,0x6D,0x6D,0x20,0x43,0x72,0x79,0x70,0x74,0x6F,0x67,0x72,
    0x61,0x70,0x68,0x69,0x63,0x20,0x4F,0x70,0x65,0x72,0x61,0x74,0x69,0x6F,0x6E,0x73,
    0x62,0x43,0x4E,0x72,0x43,0x48,0x4C,0x53,0x45,0x20,0x53,0x69,0x67,0x6E,0x69,0x6E,
    0x67,0x20,0x43,0x65,0x72,0x74,0x6C,0x53,0x75,0x62,0x6A,0x65,0x63,0x74,0x4B,0x65,
    0x79,0x49,0x44,0x40,0x69,0x53,0x75,0x62,0x6A,0x65,0x63,0x74,0x44,0x4E,0xA3,0x62,
    0x43,0x4E,0x78,0x1B,0x6F,0x65,0x6D,0x5F,0x30,0x5F,0x70,0x72,0x6A,0x5F,0x41,0x4C,
    0x4C,0x45,0x58,0x54,0x45,0x4E,0x53,0x49,0x4F,0x4E,0x53,0x43,0x45,0x52,0x54,0x61,
    0x4F,0x78,0x1B,0x51,0x75,0x61,0x6C,0x63,0x6F,0x6D,0x6D,0x20,0x54,0x65,0x63,0x68,
    0x6E,0x6F,0x6C,0x6F,0x67,0x69,0x65,0x73,0x2C,0x20,0x49,0x6E,0x63,0x2E,0x62,0x4F,
    0x55,0x78,0x21,0x51,0x75,0x61,0x6C,0x63,0x6F,0x6D,0x6D,0x20,0x43,0x72,0x79,0x70,
    0x74,0x6F,0x67,0x72,0x61,0x70,0x68,0x69,0x63,0x20,0x4F,0x70,0x65,0x72,0x61,0x74,
    0x69,0x6f,0x6e,0x73,0x78,0x19,0x45,0x78,0x70,0x69,0x72,0x61,0x74,0x69,0x6f,0x6e,
    0x57,0x69,0x74,0x68,0x47,0x72,0x61,0x63,0x65,0x50,0x65,0x72,0x69,0x6f,0x64,0x58,
    0x24,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,
    0x00,0x67,0x74,0x85,0x7f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x6e,0x4c,0x69,0x63,0x65,0x6e,0x73,0x65,0x65,0x48,0x61,
    0x73,0x68,0x65,0x73,0x40,0x64,0x46,0x49,0x44,0x73,0x81,0x18,0x45,0x69,0x46,0x49,
    0x44,0x52,0x61,0x6e,0x67,0x65,0x73,0x80,0x73,0x4c,0x69,0x63,0x65,0x6e,0x73,0x65,
    0x52,0x65,0x73,0x74,0x72,0x69,0x63,0x74,0x69,0x6f,0x6e,0x73,0x18,0xab,0x69,0x45,
    0x78,0x74,0x72,0x61,0x44,0x61,0x74,0x61,0x48,0x50,0x46,0x4d,0x52,0x6f,0x63,0x6b,
    0x73,0x64,0x46,0x6c,0x61,0x67,0x00,
    },
    407
};

static struct CheckLicenseBufferTestParams {
   const char *szTestName;
   const uint64_t uOpts;
   const uint32_t uFeatureID;
   const UsefulBufC *Cert;
   const UsefulBufC *LicenseeHash;
   const UsefulBufC *ExpLicenseCBOR;
   int ExpReturn;
   BOOLEAN ValidateResponse;
}  CLBTests[] = {

   {
      "AllExtns_Match_Test",
      0,
      69,
      &CLB_allExtns_Cert,
      &EmptyLicenseeHash,
      &ExpLicenseInfoCBOR,
      Object_OK,
      TRUE
   }
};

//CheckFeatureIds *****************************************************************
static const UsefulBufC AllExtns_RequestCBOR = {
    (uint8_t []){
    0xA2,0x6B,0x62,0x6C,0x6F,0x62,0x56,0x65,0x72,0x73,0x69,0x6F,0x6E,0x01,0x6A,0x46,
    0x65,0x61,0x74,0x75,0x72,0x65,0x49,0x44,0x73,0x81,0x82,0x18,0x45,0x40
    },
    30
};

static const UsefulBufC AllExtns_ExpResponseCBOR = {
    (uint8_t[]) {
    0x81,0x86,0x18,0x45,0x40,0x54,0x6A,0xED,0x5D,0xD3,0x09,0xE6,0xF6,0x7B,0x55,0xAF,
    0xF4,0xCC,0x00,0x00,0x01,0x79,0x48,0xDF,0xC4,0xCC,0x00,0x48,0x50,0x46,0x4D,0x52,
    0x6F,0x63,0x6B,0x73,0x00,
    },
    37
};

static const UsefulBufC NoExpiration_RequestCBOR = {
    (uint8_t []){
    0xA2,0x6B,0x62,0x6C,0x6F,0x62,0x56,0x65,0x72,0x73,0x69,0x6F,0x6E,0x01,0x6A,0x46,
    0x65,0x61,0x74,0x75,0x72,0x65,0x49,0x44,0x73,0x81,0x82,0x18,0x45,0x40
    },
    30
};

static const UsefulBufC NoExpiration_ExpResponseCBOR = {
    (uint8_t[]) {
    0x81,0x86,0x18,0x45,0x40,0x54,0x58,0x4A,0xE7,0xBD,0xC2,0x97,0xB9,0xE1,0xD8,0x85,
    0x79,0x4C,0x00,0x00,0x01,0x79,0x49,0x1B,0x48,0x5B,0x00,0x40,0x00,
    },
    29
};

static const UsefulBufC ExpiredGP_RequestCBOR = {
    (uint8_t []){
    0xA2,0x6B,0x62,0x6C,0x6F,0x62,0x56,0x65,0x72,0x73,0x69,0x6F,0x6E,0x01,0x6A,0x46,
    0x65,0x61,0x74,0x75,0x72,0x65,0x49,0x44,0x73,0x81,0x82,0x18,0x45,0x40
    },
    30
};

static const UsefulBufC ExpiredGP_ExpResponseCBOR = {
    (uint8_t[]) {
    0x81,0x86,0x18,0x45,0x40,0x54,0x44,0x57,0x8C,0x40,0xC6,0x90,0x8F,0x3A,0xD4,0xDD,
    0xD5,0xD1,0x00,0x00,0x01,0x79,0x49,0x16,0x75,0x0C,0x00,0x40,0x00,
    },
    29
};

static const UsefulBufC DeviceID_RequestCBOR = {
    (uint8_t []){
    0xA2,0x6B,0x62,0x6C,0x6F,0x62,0x56,0x65,0x72,0x73,0x69,0x6F,0x6E,0x01,0x6A,0x46,
    0x65,0x61,0x74,0x75,0x72,0x65,0x49,0x44,0x73,0x81,0x82,0x18,0x60,0x40
    },
    30
};

static const UsefulBufC DeviceID_ExpResponseCBOR = {
    (uint8_t[]) {
    0x81,0x86,0x18,0x60,0x40,0x54,0x79,0xB5,0x38,0x40,0xED,0x7D,0x51,0x39,0x22,0xFA,
    0x32,0x5B,0x00,0x00,0x01,0x79,0x49,0x21,0x51,0xB8,0x00,0x40,0x00,
    },
    29
};

static const UsefulBufC OEM1_QWESPKHash_RequestCBOR = {
    (uint8_t []){
    0xA2,0x6B,0x62,0x6C,0x6F,0x62,0x56,0x65,0x72,0x73,0x69,0x6F,0x6E,0x01,0x6A,0x46,
    0x65,0x61,0x74,0x75,0x72,0x65,0x49,0x44,0x73,0x81,0x82,0x18,0x45,0x40
    },
    30
};

static const UsefulBufC OEM1_QWESPKHash_ExpResponseCBOR = {
    (uint8_t[]) {
    0x81,0x86,0x18,0x45,0x40,0x54,0x05,0x20,0xDF,0xD5,0x75,0x26,0x7E,0x44,0x46,0xA9,
    0x66,0xEE,0x00,0x00,0x01,0x79,0x49,0x1E,0x17,0x3B,0x00,0x40,0x00,
    },
    29
};

static struct CheckFeatureIdsTestParams {
   const char *szTestName;
   const uint64_t uOpts;
   const UsefulBufC *RequestCBOR;
   const UsefulBufC *ExpResponseCBOR;
   int ExpReturn;
   BOOLEAN ValidateResponse;
}  CFITests[] = {

   {
      "AllExtns_Match_Test",
      0,
      &AllExtns_RequestCBOR,
      &AllExtns_ExpResponseCBOR,
      Object_OK,
      TRUE
   },
   {
      "NoExpiration_Test",
      0,
      &NoExpiration_RequestCBOR,
      &NoExpiration_ExpResponseCBOR,
      Object_OK,
      TRUE
   },
   {
      "ExpiredGP_Test",
      0,
      &ExpiredGP_RequestCBOR,
      &ExpiredGP_ExpResponseCBOR,
      Object_OK,
      FALSE
   },
   {
      "DeviceID_Match_Test",
      0,
      &DeviceID_RequestCBOR,
      &DeviceID_ExpResponseCBOR,
      Object_OK,
      FALSE
   },
   {
      "OEM1_QWESPKHash_Test",
      0,
      &OEM1_QWESPKHash_RequestCBOR,
      &OEM1_QWESPKHash_ExpResponseCBOR,
      Object_OK,
      TRUE
   },
};

//CheckFIDAndGetAllSerialNums *****************************************************************
static const UsefulBufC AllExtns_ExpResponseCBOR_CFAGASN = {
    (uint8_t[]) {
    0x81,0xa5,0x63,0x46,0x49,0x44,0x18,0x45,0x6c,0x4c,0x69,0x63,0x65,0x6e,0x73,0x65,
    0x65,0x48,0x61,0x73,0x68,0x40,0x66,0x52,0x65,0x73,0x75,0x6c,0x74,0x81,0xa3,0x69,
    0x53,0x65,0x72,0x69,0x61,0x6c,0x4e,0x75,0x6d,0x54,0x6a,0xed,0x5d,0xd3,0x09,0xe6,
    0xf6,0x7b,0x55,0xaf,0xf4,0xcc,0x00,0x00,0x01,0x79,0x48,0xdf,0xc4,0xcc,0x73,0x4c,
    0x69,0x63,0x65,0x6e,0x73,0x65,0x52,0x65,0x73,0x74,0x72,0x69,0x63,0x74,0x69,0x6f,
    0x6e,0x73,0x18,0xab,0x69,0x45,0x78,0x74,0x72,0x61,0x44,0x61,0x74,0x61,0x48,0x50,
    0x46,0x4d,0x52,0x6f,0x63,0x6b,0x73,0x6c,0x52,0x65,0x73,0x70,0x6f,0x6e,0x73,0x65,
    0x43,0x6f,0x64,0x65,0x00,0x64,0x46,0x6c,0x61,0x67,0x00,
    },
    123
};

static const UsefulBufC NoExpiration_ExpResponseCBOR_CFAGASN = {
    (uint8_t[]) {
    0x81,0xa5,0x63,0x46,0x49,0x44,0x18,0x45,0x6c,0x4c,0x69,0x63,0x65,0x6e,0x73,0x65,
    0x65,0x48,0x61,0x73,0x68,0x40,0x66,0x52,0x65,0x73,0x75,0x6c,0x74,0x81,0xa3,0x69,
    0x53,0x65,0x72,0x69,0x61,0x6c,0x4e,0x75,0x6d,0x54,0x58,0x4a,0xe7,0xbd,0xc2,0x97,
    0xb9,0xe1,0xd8,0x85,0x79,0x4c,0x00,0x00,0x01,0x79,0x49,0x1b,0x48,0x5b,0x73,0x4c,
    0x69,0x63,0x65,0x6e,0x73,0x65,0x52,0x65,0x73,0x74,0x72,0x69,0x63,0x74,0x69,0x6f,
    0x6e,0x73,0x03,0x69,0x45,0x78,0x74,0x72,0x61,0x44,0x61,0x74,0x61,0x40,0x6c,0x52,
    0x65,0x73,0x70,0x6f,0x6e,0x73,0x65,0x43,0x6f,0x64,0x65,0x00,0x64,0x46,0x6c,0x61,
    0x67,0x00,
    },
    114
};

static const UsefulBufC ExpiredGP_ExpResponseCBOR_CFAGASN = {
    (uint8_t[]) {
    0x81,0xa5,0x63,0x46,0x49,0x44,0x18,0x45,0x6c,0x4c,0x69,0x63,0x65,0x6e,0x73,0x65,
    0x65,0x48,0x61,0x73,0x68,0x40,0x66,0x52,0x65,0x73,0x75,0x6c,0x74,0x81,0xa3,0x69,
    0x53,0x65,0x72,0x69,0x61,0x6c,0x4e,0x75,0x6d,0x54,0x44,0x57,0x8c,0x40,0xc6,0x90,
    0x8f,0x3a,0xd4,0xdd,0xd5,0xd1,0x00,0x00,0x01,0x79,0x49,0x16,0x75,0x0c,0x73,0x4c,
    0x69,0x63,0x65,0x6e,0x73,0x65,0x52,0x65,0x73,0x74,0x72,0x69,0x63,0x74,0x69,0x6f,
    0x6e,0x73,0x18,0xa3,0x69,0x45,0x78,0x74,0x72,0x61,0x44,0x61,0x74,0x61,0x40,0x6c,
    0x52,0x65,0x73,0x70,0x6f,0x6e,0x73,0x65,0x43,0x6f,0x64,0x65,0x00,0x64,0x46,0x6c,
    0x61,0x67,0x00,
    },
    115
};

static const UsefulBufC DeviceID_ExpResponseCBOR_CFAGASN = {
    (uint8_t[]) {
    0x81,0xa5,0x63,0x46,0x49,0x44,0x18,0x60,0x6c,0x4c,0x69,0x63,0x65,0x6e,0x73,0x65,
    0x65,0x48,0x61,0x73,0x68,0x40,0x66,0x52,0x65,0x73,0x75,0x6c,0x74,0x81,0xa3,0x69,
    0x53,0x65,0x72,0x69,0x61,0x6c,0x4e,0x75,0x6d,0x54,0x68,0x56,0x0c,0xb7,0xd5,0x2a,
    0x1d,0x30,0xf3,0xe4,0xb1,0xfb,0x00,0x00,0x01,0x7a,0x1b,0x81,0x55,0xc1,0x73,0x4c,
    0x69,0x63,0x65,0x6e,0x73,0x65,0x52,0x65,0x73,0x74,0x72,0x69,0x63,0x74,0x69,0x6f,
    0x6e,0x73,0x18,0xa7,0x69,0x45,0x78,0x74,0x72,0x61,0x44,0x61,0x74,0x61,0x40,0x6c,
    0x52,0x65,0x73,0x70,0x6f,0x6e,0x73,0x65,0x43,0x6f,0x64,0x65,0x00,0x64,0x46,0x6c,
    0x61,0x67,0x00,
    },
    115
};

static const UsefulBufC OEM1_QWESPKHash_ExpResponseCBOR_CFAGASN = {
    (uint8_t[]) {
    0x81,0xa5,0x63,0x46,0x49,0x44,0x18,0x45,0x6c,0x4c,0x69,0x63,0x65,0x6e,0x73,0x65,
    0x65,0x48,0x61,0x73,0x68,0x40,0x66,0x52,0x65,0x73,0x75,0x6c,0x74,0x81,0xa3,0x69,
    0x53,0x65,0x72,0x69,0x61,0x6c,0x4e,0x75,0x6d,0x54,0x05,0x20,0xdf,0xd5,0x75,0x26,
    0x7e,0x44,0x46,0xa9,0x66,0xee,0x00,0x00,0x01,0x79,0x49,0x1e,0x17,0x3b,0x73,0x4c,
    0x69,0x63,0x65,0x6e,0x73,0x65,0x52,0x65,0x73,0x74,0x72,0x69,0x63,0x74,0x69,0x6f,
    0x6e,0x73,0x18,0xab,0x69,0x45,0x78,0x74,0x72,0x61,0x44,0x61,0x74,0x61,0x40,0x6c,
    0x52,0x65,0x73,0x70,0x6f,0x6e,0x73,0x65,0x43,0x6f,0x64,0x65,0x00,0x64,0x46,0x6c,
    0x61,0x67,0x00,
    },
    115
};

static struct CheckFIDAndGetAllSerialNumsTestParams {
   const char *szTestName;
   const uint64_t uOpts;
   const UsefulBufC *RequestCBOR;
   const UsefulBufC *ExpResponseCBOR;
   int ExpReturn;
   BOOLEAN ValidateResponse;
}  CFAGASNTests[] = {

   {
      "AllExtns_Match_Test",
      0,
      &AllExtns_RequestCBOR,
      &AllExtns_ExpResponseCBOR_CFAGASN,
      Object_OK,
      TRUE
   },
   {
      "NoExpiration_Test",
      0,
      &NoExpiration_RequestCBOR,
      &NoExpiration_ExpResponseCBOR_CFAGASN,
      Object_OK,
      TRUE
   },
   {
      "ExpiredGP_Test",
      0,
      &ExpiredGP_RequestCBOR,
      &ExpiredGP_ExpResponseCBOR_CFAGASN,
      Object_OK,
      TRUE
   },
   {
      "DeviceID_Match_Test",
      0,
      &DeviceID_RequestCBOR,
      &DeviceID_ExpResponseCBOR_CFAGASN,
      Object_OK,
      TRUE
   },
   {
      "OEM1_QWESPKHash_Test",
      0,
      &OEM1_QWESPKHash_RequestCBOR,
      &OEM1_QWESPKHash_ExpResponseCBOR_CFAGASN,
      Object_OK,
      TRUE
   },
};

/*-----------------------------------------------------------------------------------
 INTERNAL FUNCTION DEFINITIONS
 -------------------------------------------------------------------------------------*/
void Usage() 
{
    AsciiPrint("\n*************************************************************\n");
    AsciiPrint("************          QWES TEST APP        ************\n");
    AsciiPrint("*************************************************************\n");
    AsciiPrint(
    "Run the following command from uefi cmd shell to execute QWESTests - PFM\n"
    "st qwestest <Test Suite ID>\n"
    "<Test Suite ID> : Test Suite ID should be > 0\n"
    "\n"
    "Example:-\n"
    "1) st qwestest 1\n"
    "2) st qwestest 2\n");
    AsciiPrint(
    "\nSupported Test Suite IDs:-\n"
    " 1 - CheckInstalledLicense Tests\n"
    " 2 - GetInstalledLicenseInfo Tests\n"
    " 3 - GetAllInstalledSerialNumbers Tests\n"
    " 4 - CheckLicenseBuffer Tests\n"
    " 5 - CheckFeatureIds Tests\n"
    " 6 - CheckFIDAndGetAllSerialNums Tests\n"
    "*************************************************************\n");
}


static char hex(uint8_t val) {
    const char digits[16] = "0123456789abcdef";
    return val >= sizeof(digits) ? '?' : digits[val];
}


size_t hexlify(char* buf, size_t buf_len, uint8_t const* bytes, size_t bytes_len) {
    if (!buf || !buf_len) {
        AsciiPrint("buf");
        return bytes_len;
    }
    while (bytes_len > 0 && buf_len > 2) {
        uint8_t b = *bytes++;
        *buf++ = hex(b >> 4);
        *buf++ = hex(b & 0xF);
        buf_len -= 2;
        bytes_len--;
    }
    *buf = '\0';
    return bytes_len;
}


void qwes_log_buffer(void const* void_buf, uint32_t buflen, const char* msg) {
    // Log Buffer Name (Message) and its length
    AsciiPrint("\n %a - 0x%x (Data Length)", msg, buflen);

    // uint8_t const* buf = (uint8_t const*)void_buf;
    uint8_t const* buf = void_buf;
    // Just return in case of NULL or length is 0
    if ((buf == NULL) || (buflen == 0)) {
        AsciiPrint("");
        return;
    }

    char line_buffer[MAX_HEX_LEN] = {0};
    uint32_t i = 0;
    for (i = 0; i + HEX_COLUMNS < buflen; i += HEX_COLUMNS) {
        hexlify(line_buffer, sizeof(line_buffer), buf + i, HEX_COLUMNS);
        AsciiPrint("\n %a", line_buffer);
    }
    if (i < buflen) {
        uint32_t remaining = buflen - i;
        // won't happen but makes it easier to review
        if (remaining > HEX_COLUMNS) {
            remaining = HEX_COLUMNS;
        }
        hexlify(line_buffer, sizeof(line_buffer), buf + i, remaining);
        AsciiPrint("\n %a", line_buffer);
    }

    AsciiPrint("\n");
    return;
}


void Deinit()
{
    Object_RELEASE_IF(appObj);
    appObj = Object_NULL;
    Object_RELEASE_IF(clientEnv);
    clientEnv = Object_NULL;

    return;
}


int Init(uint64_t uOpts)
{
    int nReturn = 0;

    nReturn = ScmProtocol->ScmGetClientEnv(ScmProtocol, &clientEnv);
    if (nReturn) {
        AsciiPrint("\nScmGetClientEnv - Fail, nReturn = %d", nReturn);
        clientEnv = Object_NULL;
        nReturn = Fail;
        goto Done;
    }

    nReturn = IClientEnv_open(clientEnv, CPFM_UID, &appObj);
    if (nReturn) {
        AsciiPrint("\nIClientEnv_open - Fail, nReturn = %d", nReturn);
        appObj = Object_NULL;
        nReturn = Fail;
        goto Done;
    }

    if (uOpts) {
        nReturn = IPFM_SetOptions(appObj, uOpts);
        if (nReturn) {
            AsciiPrint("\nIPFM_SetOptions - Fail, nReturn = %d", nReturn);
            nReturn = Fail;
            goto Done;
        }
    }

    Done:
    if (nReturn) {
        Deinit();
    }

    return nReturn;
}


int CheckInstalledLicenseTests(int nTestNumber, const char **pszTestName)
{
    int nReturn = 0;
    struct CheckInstalledLicenseTestParams *pTest = NULL;

    if((unsigned long)nTestNumber >= sizeof(CILTests) / sizeof(struct CheckInstalledLicenseTestParams)) {
        return EndOfList;
    }

    pTest = &CILTests[nTestNumber];
    *pszTestName = pTest->szTestName;

    nReturn = Init(pTest->uOpts);
    if (nReturn) {
        AsciiPrint("\nInit - Fail, nReturn = %d", nReturn);
        nReturn = Fail;
        goto Done;
    }

    MakeUsefulBufOnStack(SerialNum, MAX_SERIAL_NUM);
    MakeUsefulBufOnStack(FIDsCBOR, MAX_FIDs_CBOR);
    uint64_t LicRestrictions = 0;
    if (!UsefulBuf_IsNULLOrEmpty(*pTest->Cert)) {
        nReturn = IPFM_InstallLicense(appObj,
                                      pTest->Cert->ptr,
                                      pTest->Cert->len,
                                      SerialNum.ptr,
                                      SerialNum.len,
                                      &SerialNum.len,
                                      FIDsCBOR.ptr,
                                      FIDsCBOR.len,
                                      &FIDsCBOR.len,
                                      &LicRestrictions);
        if (nReturn) {
            AsciiPrint("\nIPFM_InstallLicense - Fail, nReturn = %d", nReturn);
            nReturn = Fail;
            goto Done;
        }
    }

    UsefulBuf_Set(&SerialNum, 0);
    nReturn = IPFM_CheckInstalledLicense(appObj,
                                         pTest->uFeatureID,
                                         pTest->LicenseeHash->ptr,
                                         pTest->LicenseeHash->len,
                                         SerialNum.ptr,
                                         SerialNum.len,
                                         &(SerialNum.len));

    if (!UsefulBuf_IsNULLOrEmpty(*pTest->Cert)) {
        int nResult = IPFM_RemoveLicense(appObj, SerialNum.ptr, SerialNum.len);
        if (nResult) {
            AsciiPrint("\nIPFM_RemoveLicense - Fail, nResult = %d", nResult);
            nReturn = Fail;
            goto Done;
        }
    }

    if (nReturn != pTest->ExpReturn) {
        AsciiPrint("\nReturn code wasn't as expected - Exp=%d, Act=%d \n\n", pTest->ExpReturn, nReturn);
        nReturn = Fail;
        goto Done;
    }

    if (nReturn) {
        nReturn = Pass;
        goto Done;
    }

    if (pTest->ValidateResponse) {
        if (pTest->ExpSerialNum->ptr && (UsefulBuf_Compare(*(pTest->ExpSerialNum), UsefulBuf_Const(SerialNum)))) {
            AsciiPrint("\nSerialNumber wasn't as expected.");
            qwes_log_buffer((uint8_t*)pTest->ExpSerialNum->ptr, pTest->ExpSerialNum->len, "ExpectedSerialNum");
            qwes_log_buffer((uint8_t*)SerialNum.ptr, SerialNum.len, "ActualSerialNum");
            nReturn = Fail;
            goto Done;
        }
    }

    Done:
    Deinit();

    return nReturn;
}


int GetInstalledLicenseInfoTests(int nTestNumber, const char **pszTestName)
{
    int nReturn = 0;
    struct GetInstalledLicenseInfoTestParams *pTest = NULL;

    if((unsigned long)nTestNumber >= sizeof(GILITests) / sizeof(struct GetInstalledLicenseInfoTestParams)) {
        return EndOfList;
    }

    pTest = &GILITests[nTestNumber];
    *pszTestName = pTest->szTestName;

    nReturn = Init(pTest->uOpts);
    if (nReturn) {
        AsciiPrint("\nInit - Fail, nReturn = %d", nReturn);
        nReturn = Fail;
        goto Done;
    }

    MakeUsefulBufOnStack(SerialNum, MAX_SERIAL_NUM);
    MakeUsefulBufOnStack(FIDsCBOR, MAX_FIDs_CBOR);
    uint64_t LicRestrictions = 0;
    if (!UsefulBuf_IsNULLOrEmpty(*pTest->Cert)) {
        nReturn = IPFM_InstallLicense(appObj,
                                      pTest->Cert->ptr,
                                      pTest->Cert->len,
                                      SerialNum.ptr,
                                      SerialNum.len,
                                      &SerialNum.len,
                                      FIDsCBOR.ptr,
                                      FIDsCBOR.len,
                                      &FIDsCBOR.len,
                                      &LicRestrictions);
        if (nReturn) {
            AsciiPrint("\nIPFM_InstallLicense - Fail, nReturn = %d", nReturn);
            nReturn = Fail;
            goto Done;
        }
    }
    else {
        UsefulBuf_Copy(&SerialNum, *pTest->SerialNum);
    }

    MakeUsefulBufOnStack(ResponseCBOR, MAX_RESPONSE_CBOR);
    UsefulBuf_Set(&ResponseCBOR, 0);
    nReturn = IPFM_GetInstalledLicenseInfo(appObj,
                                           SerialNum.ptr,
                                           SerialNum.len,
                                           ResponseCBOR.ptr,
                                           ResponseCBOR.len,
                                           &ResponseCBOR.len);

    if (!UsefulBuf_IsNULLOrEmpty(*pTest->Cert)) {
        int nResult = IPFM_RemoveLicense(appObj, SerialNum.ptr, SerialNum.len);
        if (nResult) {
            AsciiPrint("\nIPFM_RemoveLicense - Fail, nResult = %d", nResult);
            nReturn = Fail;
            goto Done;
        }
    }

    if (nReturn != pTest->ExpReturn) {
        AsciiPrint("\nReturn code wasn't as expected - Exp=%d, Act=%d \n\n", pTest->ExpReturn, nReturn);
        nReturn = Fail;
        goto Done;
    }

    if (nReturn) {
        nReturn = Pass;
        goto Done;
    }

    if (pTest->ValidateResponse) {
        if (pTest->ExpResponseCBOR->ptr && (UsefulBuf_Compare(*(pTest->ExpResponseCBOR), UsefulBuf_Const(ResponseCBOR)))) {
            AsciiPrint("\nResponseCBOR wasn't as expected.");
            qwes_log_buffer((uint8_t*)pTest->ExpResponseCBOR->ptr, pTest->ExpResponseCBOR->len, "ExpectedResponseCBOR");
            qwes_log_buffer((uint8_t*)ResponseCBOR.ptr, ResponseCBOR.len, "ActualResponseCBOR");
            nReturn = Fail;
            goto Done;
        }
    }

    Done:
    Deinit();

    return nReturn;
}


int GetAllInstalledSerialNumbersTests(int nTestNumber, const char **pszTestName)
{
    int nReturn = 0;
    struct GetAllInstalledSerialNumbersTestParams *pTest = NULL;

    if((unsigned long)nTestNumber >= sizeof(GAISNTests) / sizeof(struct GetAllInstalledSerialNumbersTestParams)) {
       return EndOfList;
    }

    pTest = &GAISNTests[nTestNumber];
    *pszTestName = pTest->szTestName;

    nReturn = Init(pTest->uOpts);
    if (nReturn) {
        AsciiPrint("\nInit - Fail, nReturn = %d", nReturn);
        nReturn = Fail;
        goto Done;
    }

    MakeUsefulBufOnStack(SerialNumCBOR, MAX_RESPONSE_CBOR);
    UsefulBuf_Set(&SerialNumCBOR, 0);   
    nReturn = IPFM_GetAllInstalledSerialNumbers(appObj,
                                                SerialNumCBOR.ptr,
                                                SerialNumCBOR.len,
                                                &SerialNumCBOR.len);

    if (nReturn != pTest->ExpReturn) {
        AsciiPrint("\nReturn code wasn't as expected - Exp=%d, Act=%d \n\n", pTest->ExpReturn, nReturn);
        nReturn = Fail;
        goto Done;
    }

    if (nReturn) {
        nReturn = Pass;
        goto Done;
    }

    if (pTest->ValidateResponse) {
        if (pTest->ExpSerialNumCBOR->ptr && (UsefulBuf_Compare(*(pTest->ExpSerialNumCBOR), UsefulBuf_Const(SerialNumCBOR)))) {
            AsciiPrint("\nSerialNumberCBOR wasn't as expected.");
            qwes_log_buffer((uint8_t*)pTest->ExpSerialNumCBOR->ptr, pTest->ExpSerialNumCBOR->len, "ExpectedSerialNumCBOR");
            qwes_log_buffer((uint8_t*)SerialNumCBOR.ptr, SerialNumCBOR.len, "ActualSerialNumCBOR");
            nReturn = Fail;
            goto Done;
        }
    }

    Done:
    Deinit();

    return nReturn;
}


int CheckLicenseBufferTests(int nTestNumber, const char **pszTestName)
{
    int nReturn = 0;
    struct CheckLicenseBufferTestParams *pTest = NULL;

    if((unsigned long)nTestNumber >= sizeof(CLBTests) / sizeof(struct CheckLicenseBufferTestParams)) {
        return EndOfList;
    }

    pTest = &CLBTests[nTestNumber];
    *pszTestName = pTest->szTestName;

    nReturn = Init(pTest->uOpts);
    if (nReturn) {
        AsciiPrint("\nInit - Fail, nReturn = %d", nReturn);
        nReturn = Fail;
        goto Done;
    }

    MakeUsefulBufOnStack(LicenseCBOR, MAX_RESPONSE_CBOR);
    UsefulBuf_Set(&LicenseCBOR, 0);
    nReturn = IPFM_CheckLicenseBuffer(appObj,
                                      pTest->Cert->ptr,
                                      pTest->Cert->len,
                                      pTest->uFeatureID,
                                      pTest->LicenseeHash->ptr,
                                      pTest->LicenseeHash->len,
                                      LicenseCBOR.ptr,
                                      LicenseCBOR.len,
                                      &(LicenseCBOR.len));

    if (nReturn != pTest->ExpReturn) {
        AsciiPrint("\nReturn code wasn't as expected - Exp=%d, Act=%d \n\n", pTest->ExpReturn, nReturn);
        nReturn = Fail;
        goto Done;
    }

    if (nReturn) {
        nReturn = Pass;
        goto Done;
    }

    if (pTest->ValidateResponse) {
        if (pTest->ExpLicenseCBOR->ptr && (UsefulBuf_Compare(*(pTest->ExpLicenseCBOR), UsefulBuf_Const(LicenseCBOR)))) {
            AsciiPrint("\nLicenseCBOR wasn't as expected.");
            qwes_log_buffer((uint8_t*)pTest->ExpLicenseCBOR->ptr, pTest->ExpLicenseCBOR->len, "ExpectedLicenseCBOR");
            qwes_log_buffer((uint8_t*)LicenseCBOR.ptr, LicenseCBOR.len, "ActualLicenseCBOR");
            nReturn = Fail;     
            goto Done;
        }
    }

    Done:
    Deinit();

    return nReturn;
}


int CheckFeatureIdsTests(int nTestNumber, const char **pszTestName)
{
    int nReturn = 0;
    struct CheckFeatureIdsTestParams *pTest = NULL;

    if((unsigned long)nTestNumber >= sizeof(CFITests) / sizeof(struct CheckFeatureIdsTestParams)) {
        return EndOfList;
    }

    pTest = &CFITests[nTestNumber];
    *pszTestName = pTest->szTestName;

    nReturn = Init(pTest->uOpts);
    if (nReturn) {
        AsciiPrint("\nInit - Fail, nReturn = %d", nReturn);
        nReturn = Fail;
        goto Done;
    }

    MakeUsefulBufOnStack(ResponseCBOR, MAX_RESPONSE_CBOR);
    UsefulBuf_Set(&ResponseCBOR, 0);
    nReturn = IPFM_CheckFeatureIds(appObj,
                                   pTest->RequestCBOR->ptr,
                                   pTest->RequestCBOR->len,
                                   ResponseCBOR.ptr,
                                   ResponseCBOR.len,
                                   &(ResponseCBOR.len));

    if (nReturn != pTest->ExpReturn) {
        AsciiPrint("\nReturn code wasn't as expected - Exp=%d, Act=%d \n\n", pTest->ExpReturn, nReturn);
        nReturn = Fail;
        goto Done;
    }

    if (nReturn) {
        nReturn = Pass;
        goto Done;
    }

    if (pTest->ValidateResponse) {
        if (pTest->ExpResponseCBOR->ptr && (UsefulBuf_Compare(*(pTest->ExpResponseCBOR), UsefulBuf_Const(ResponseCBOR)))) {
            AsciiPrint("\nResponseCBOR wasn't as expected.");
            qwes_log_buffer((uint8_t*)pTest->ExpResponseCBOR->ptr, pTest->ExpResponseCBOR->len, "ExpectedResponseCBOR");
            qwes_log_buffer((uint8_t*)ResponseCBOR.ptr, ResponseCBOR.len, "ActualResponseCBOR");
            nReturn = Fail;
            goto Done;
        }
    }

    Done:
    Deinit();

    return nReturn;
}


int CheckFIDAndGetAllSerialNums(int nTestNumber, const char **pszTestName)
{
    int nReturn = 0;
    struct CheckFIDAndGetAllSerialNumsTestParams *pTest = NULL;

    if((unsigned long)nTestNumber >= sizeof(CFAGASNTests) / sizeof(struct CheckFIDAndGetAllSerialNumsTestParams)) {
        return EndOfList;
    }

    pTest = &CFAGASNTests[nTestNumber];
    *pszTestName = pTest->szTestName;

    nReturn = Init(pTest->uOpts);
    if (nReturn) {
        AsciiPrint("\nInit - Fail, nReturn = %d", nReturn);
        nReturn = Fail;
        goto Done;
    }

    MakeUsefulBufOnStack(ResponseCBOR, MAX_RESPONSE_CBOR);
    UsefulBuf_Set(&ResponseCBOR, 0);
    nReturn = IPFM_CheckFIDAndGetAllSerialNums(appObj,
                                               pTest->RequestCBOR->ptr,
                                               pTest->RequestCBOR->len,
                                               ResponseCBOR.ptr,
                                               ResponseCBOR.len,
                                               &(ResponseCBOR.len));

    if (nReturn != pTest->ExpReturn) {
        AsciiPrint("\nReturn code wasn't as expected - Exp=%d, Act=%d \n\n", pTest->ExpReturn, nReturn);
        nReturn = Fail;
        goto Done;
    }

    if (nReturn) {
        nReturn = Pass;
        goto Done;
    }

    if (pTest->ValidateResponse) {
        if (pTest->ExpResponseCBOR->ptr && (UsefulBuf_Compare(*(pTest->ExpResponseCBOR), UsefulBuf_Const(ResponseCBOR)))) {
            AsciiPrint("\nResponseCBOR wasn't as expected.");
            qwes_log_buffer((uint8_t*)pTest->ExpResponseCBOR->ptr, pTest->ExpResponseCBOR->len, "ExpectedResponseCBOR");
            qwes_log_buffer((uint8_t*)ResponseCBOR.ptr, ResponseCBOR.len, "ActualResponseCBOR");
            nReturn = Fail;
            goto Done;
        }
    }

    Done:
    Deinit();

    return nReturn;
}


void TestsHdlr(const char *pszAPITestName, APITestsCallBack fCallBack)
{
    int status = Pass;
    int nTestNum = 0;
    int nTestResult = Pass;
    const char *szTestName = NULL;

    AsciiPrint("\n ************ %a Tests ************ \n\n", pszAPITestName);

    do
    {
        nTestResult = fCallBack(nTestNum, &szTestName);
        if (nTestResult == EndOfList)
            break;
        if (nTestResult == Fail)
            status = Fail;

        if (nTestResult == Fail)
            AsciiPrint("\n %d. %a %a \n\n", nTestNum+1, szTestName, "FAIL");
        else
            AsciiPrint("\n %d. %a %a \n\n", nTestNum+1, szTestName, "PASS");

        nTestNum++;
    } while(1);

    if (status == Fail)
        AsciiPrint("\n %a Tests - %a \n\n", pszAPITestName, "FAIL");
    else
        AsciiPrint("\n %a Tests - %a \n\n", pszAPITestName, "PASS");

    return;
}


EFI_STATUS
EFIAPI
UefiMain (   IN EFI_HANDLE ImageHandle, IN EFI_SYSTEM_TABLE  *SystemTable)
{
    EFI_STATUS nReturn = EFI_SUCCESS;
    UINTN argc;
    CHAR8 **argv = NULL;

    nReturn = gBS->LocateProtocol (&gQcomScmProtocolGuid, NULL, (VOID**)&ScmProtocol);
    if (nReturn) {
        AsciiPrint("\n gQcomScmProtocolGuid - Fail, nReturn = %d \n\n", nReturn);
        return nReturn;
    }

    nReturn = gBS->LocateProtocol(&gEfiShmBridgeProtocolGuid, NULL, (VOID **)&ShmBridgeProtocol);
    if (nReturn) {
        AsciiPrint("\n gEfiShmBridgeProtocolGuid - Fail, nReturn = %d \n\n", nReturn);
        return nReturn;
    }

    nReturn = GetCmdLineArgs(ImageHandle, &argc, &argv);
    if (nReturn) {
        AsciiPrint("\n GetCmdLineArgs - Fail, nReturn = %d \n\n", nReturn);
        return nReturn;
    }

    if (argc < 1) {
        Usage();
        nReturn = EFI_SUCCESS;
        return nReturn;
    }

    switch (AsciiStrDecimalToUintn(argv[0])) {
        case 1:
            TestsHdlr("CheckInstalledLicense", CheckInstalledLicenseTests);
            break;

        case 2:
            TestsHdlr("GetInstalledLicenseInfo", GetInstalledLicenseInfoTests);
            break;

        case 3:
            TestsHdlr("GetAllInstalledSerialNumbers", GetAllInstalledSerialNumbersTests);
            break;

        case 4:
            TestsHdlr("CheckLicenseBuffer", CheckLicenseBufferTests);
            break;

        case 5:
            TestsHdlr("CheckFeatureIds", CheckFeatureIdsTests);
            break;

        case 6:
            TestsHdlr("CheckFIDAndGetAllSerialNums", CheckFIDAndGetAllSerialNums);
            break;

        default:
            AsciiPrint("\n Unsupported TestSuite ID - %d", AsciiStrDecimalToUintn(argv[0]));
            Usage();
            break;
    }

    nReturn = EFI_SUCCESS;
    return nReturn;
}
