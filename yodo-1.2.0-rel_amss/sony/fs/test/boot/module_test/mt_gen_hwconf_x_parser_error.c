#include "iterator.h"
#include "integration_main.h"
#include "hwconf_x_parser.h"
#include <string.h>

/* Test 1:
 * Too small root sequence length
 */
static const uint8_t hwconf_payload1[44] = {
	0x30, 0x29, 0x02, 0x01, 0x01, 0x01, 0x01, 0xff,
	0x30, 0x10, 0x0c, 0x0e, 0x30, 0x30, 0x34, 0x36,
	0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38,
	0x39, 0x30, 0x04, 0x10, 0xbe, 0x7f, 0x63, 0x0e,
	0xd5, 0xc5, 0x56, 0xb7, 0xb2, 0x9b, 0xff, 0x29,
	0xee, 0x51, 0x62, 0xb4
};
static const int result1 = -FCSERR_EINFOR;

/* Test 2:
 * Too large root sequence length
 */
static const uint8_t hwconf_payload2[44] = {
	0x30, 0x2b, 0x02, 0x01, 0x01, 0x01, 0x01, 0xff,
	0x30, 0x10, 0x0c, 0x0e, 0x30, 0x30, 0x34, 0x36,
	0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38,
	0x39, 0x30, 0x04, 0x10, 0xbe, 0x7f, 0x63, 0x0e,
	0xd5, 0xc5, 0x56, 0xb7, 0xb2, 0x9b, 0xff, 0x29,
	0xee, 0x51, 0x62, 0xb4
};
static const int result2 = -FCSERR_EINFOR;

/* Test 3:
 * Version not 1
 */
static const uint8_t hwconf_payload3[44] = {
	0x30, 0x2a, 0x02, 0x01, 0x02, 0x01, 0x01, 0xff,
	0x30, 0x10, 0x0c, 0x0e, 0x30, 0x30, 0x34, 0x36,
	0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38,
	0x39, 0x30, 0x04, 0x10, 0xbe, 0x7f, 0x63, 0x0e,
	0xd5, 0xc5, 0x56, 0xb7, 0xb2, 0x9b, 0xff, 0x29,
	0xee, 0x51, 0x62, 0xb4
};
static const int result3 = -FCSERR_EINVAL;

/* Test 4:
 * Missing isprototype
 */
static const uint8_t hwconf_payload4[41] = {
	0x30, 0x27, 0x02, 0x01, 0x02,
	0x30, 0x10, 0x0c, 0x0e, 0x30, 0x30, 0x34, 0x36,
	0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38,
	0x39, 0x30, 0x04, 0x10, 0xbe, 0x7f, 0x63, 0x0e,
	0xd5, 0xc5, 0x56, 0xb7, 0xb2, 0x9b, 0xff, 0x29,
	0xee, 0x51, 0x62, 0xb4
};
static const int result4 = -FCSERR_EINFOR;

/* Test 5:
 * Too few imei
 */
static const uint8_t hwconf_payload5[28] = {
	0x30, 0x1A, 0x02, 0x01, 0x01, 0x01, 0x01, 0x00,
	0x30, 0x00, 0x04, 0x10, 0xCE, 0x7F, 0x63, 0x0E,
	0xD5, 0xC5, 0x56, 0xB7, 0xB2, 0x9B, 0xFF, 0x29,
	0xEE, 0x51, 0x62, 0xB8
};
static const int result5 = -FCSERR_ENOTF;

/* Test 6:
 * Too many imei
 */
static const uint8_t hwconf_payload6[76] = {
	0x30, 0x4A, 0x02, 0x01, 0x01, 0x01, 0x01, 0x00,
	0x30, 0x30, 0x0C, 0x0E, 0x30, 0x30, 0x34, 0x36,
	0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38,
	0x39, 0x31, 0x0C, 0x0E, 0x30, 0x30, 0x34, 0x36,
	0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38,
	0x39, 0x32, 0x0C, 0x0E, 0x30, 0x30, 0x34, 0x36,
	0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38,
	0x39, 0x33, 0x04, 0x10, 0xCE, 0x7F, 0x63, 0x0E,
	0xD5, 0xC5, 0x56, 0xB7, 0xB2, 0x9B, 0xFF, 0x29,
	0xEE, 0x51, 0x62, 0xB8
};
static const int result6 = -FCSERR_EINVAL;

/* Test 7:
 * Imei with invalid characters
 */
static const uint8_t hwconf_payload7[44] = {
	0x30, 0x2A, 0x02, 0x01, 0x01, 0x01, 0x01, 0x00,
	0x30, 0x10, 0x0C, 0x0E, 0x30, 0x30, 0x34, 0x36,
	0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38,
	0x39, 0x41, 0x04, 0x10, 0xCE, 0x7F, 0x63, 0x0E,
	0xD5, 0xC5, 0x56, 0xB7, 0xB2, 0x9B, 0xFF, 0x29,
	0xEE, 0x51, 0x62, 0xB8
};
static const int result7 = -FCSERR_EINVAL;

/* Test 8:
 * Imei size is invalid
 */
static const uint8_t hwconf_payload8[45] = {
	0x30, 0x2B, 0x02, 0x01, 0x01, 0x01, 0x01, 0x00,
	0x30, 0x11, 0x0C, 0x0F, 0x30, 0x30, 0x34, 0x36,
	0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38,
	0x39, 0x30, 0x30, 0x04, 0x10, 0xCE, 0x7F, 0x63,
	0x0E, 0xD5, 0xC5, 0x56, 0xB7, 0xB2, 0x9B, 0xFF,
	0x29, 0xEE, 0x51, 0x62, 0xB8
};
static const int result8 = -FCSERR_EINVAL;

/* Test 9:
 * DK size is invalid
 */
static const uint8_t hwconf_payload9[45] = {
	0x30, 0x2B, 0x02, 0x01, 0x01, 0x01, 0x01, 0x00,
	0x30, 0x10, 0x0C, 0x0E, 0x30, 0x30, 0x34, 0x36,
	0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38,
	0x39, 0x30, 0x04, 0x11, 0xCE, 0x7F, 0x63, 0x0E,
	0xD5, 0xC5, 0x56, 0xB7, 0xB2, 0x9B, 0xFF, 0x29,
	0xEE, 0x51, 0x62, 0xB8, 0x00
};
static const int result9 = -FCSERR_EINVAL;

static int module_verify_invalid_payload(
		fcsmt_log_t log,
		const uint8_t *payload,
		size_t payload_size,
		int expected_res)
{
	int res = FCSERR_OK;
	int test_res = FCSERR_OK;
	hwconf_x_handle_t handle = NULL;

	test_res = hwconf_x_parser_init(&handle,
			(uint8_t *)payload,
			payload_size);
	if (test_res != expected_res) {
		log("hwconf_parser_init res: %d, expected: %d\n",
			test_res, expected_res);
		res = -FCSERR_EOPFAIL;
	}

	hwconf_x_parser_deinit(handle);
	return res;
}

int execute_module_gen_hwconf_x_parser_error(
		struct iterator_info *it,
		fcsmt_log_t log,
		const char *match)
{
	int res = FCSERR_OK;

	switch (it->cur_module_item) {
	case 0:
		/* If unexpected shutdown goto 2 */
		set_next_module_item(it, 1);
		export_tcstate(it);


		/* Test 1:
		 * Too small root sequence length
		 */
		res = module_verify_invalid_payload(
			log,
			hwconf_payload1, sizeof(hwconf_payload1),
			result1);
		if (res != FCSERR_OK) {
			log("Verify 1 failed\n");
			goto test_failure;
		}

		/* Test 2:
		 * Too large root sequence length
		 */
		res = module_verify_invalid_payload(
			log,
			hwconf_payload2, sizeof(hwconf_payload2),
			result2);
		if (res != FCSERR_OK) {
			log("Verify 2 failed\n");
			goto test_failure;
		}

		/* Test 3:
		 * Version not 1
		 */
		res = module_verify_invalid_payload(
			log,
			hwconf_payload3, sizeof(hwconf_payload3),
			result3);
		if (res != FCSERR_OK) {
			log("Verify 3 failed\n");
			goto test_failure;
		}

		/* Test 4:
		 * Missing isprototype
		 */
		res = module_verify_invalid_payload(
			log,
			hwconf_payload4, sizeof(hwconf_payload4),
			result4);
		if (res != FCSERR_OK) {
			log("Verify 4 failed\n");
			goto test_failure;
		}

		/* Test 5:
		 * Too few imei
		 */
		res = module_verify_invalid_payload(
			log,
			hwconf_payload5, sizeof(hwconf_payload5),
			result5);
		if (res != FCSERR_OK) {
			log("Verify 5 failed\n");
			goto test_failure;
		}

		/* Test 6:
		 * Too many imei
		 */
		res = module_verify_invalid_payload(
			log,
			hwconf_payload6, sizeof(hwconf_payload6),
			result6);
		if (res != FCSERR_OK) {
			log("Verify 6 failed\n");
			goto test_failure;
		}

		/* Test 7:
		 * Imei with invalid characters
		 */
		res = module_verify_invalid_payload(
			log,
			hwconf_payload7, sizeof(hwconf_payload7),
			result7);
		if (res != FCSERR_OK) {
			log("Verify 7 failed\n");
			goto test_failure;
		}

		/* Test 8:
		 * Imei size is invalid
		 */
		res = module_verify_invalid_payload(
			log,
			hwconf_payload8, sizeof(hwconf_payload8),
			result8);
		if (res != FCSERR_OK) {
			log("Verify 8 failed\n");
			goto test_failure;
		}

		/* Test 9:
		 * DK size is invalid
		 */
		res = module_verify_invalid_payload(
			log,
			hwconf_payload9, sizeof(hwconf_payload9),
			result9);
		if (res != FCSERR_OK) {
			log("Verify 9 failed\n");
			goto test_failure;
		}

		/* We got through the test, goto next test */
		inc_n_executed(it);
		set_next_module_item(it, -1);
		break;
	default:
		/* Unexpected shutdown/restart */
		goto test_failure;
	}

	return FCSERR_OK;

test_failure:
	set_next_module_item(it, -1);
	inc_n_failed(it);
	inc_n_executed(it);
	return FCSERR_OK;
}


